<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HTTP Session Management :: Eclipse Jetty</title>
    <link rel="canonical" href="https://jetty.org/docs/jetty/12/programming-guide/server/session.html">
    <link rel="prev" href="compliance.html">
    <link rel="next" href="websocket.html">
    <meta name="generator" content="Antora 3.1.7">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VS4ZRD6HVM"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','G-VS4ZRD6HVM')</script>
    <link rel="icon" href="../../../../../_/img/favicon.ico" type="image/x-icon"/>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item logo" href="https://jetty.org"><img src="../../../../../_/img/jetty-logo.svg" alt="Eclipse Jetty" width="120"></a>
      <a class="navbar-item" href="https://jetty.org">Eclipse Jetty</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search the docs">
          </div>
        </div>
        <a class="navbar-item" href="../../../../index.html">Documentation</a>
        <a class="navbar-item" href="../../../../../support.html">Support</a>
        <!--a class="navbar-item" href="../../../../../community.html">Community</a-->
        <a class="navbar-item" href="../../../../../security.html">Security</a>
        <a class="navbar-item" href="../../../../../download.html">Download</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Links</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/jetty/jetty.project">Source Code</a>
            <a class="navbar-item" href="https://github.com/jetty/jetty.project/issues">Issues</a>
            <a class="navbar-item" href="../../../../contribution-guide/index.html">Contributing</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="jetty" data-version="12">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../index.html">Eclipse Jetty</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../operations-guide/index.html">Operations Guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/begin/index.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/features/index.html">Eclipse Jetty Features</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/howtos/index.html">Eclipse Jetty How-Tos</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/arch/index.html">Architecture Overview</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../operations-guide/start/index.html">Jetty Start Mechanism</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../operations-guide/start/start-jpms.html">Starting Jetty using JPMS</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../operations-guide/modules/index.html">Jetty Modules</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../operations-guide/modules/custom.html">Custom Jetty Modules</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../operations-guide/modules/standard.html">Standard Modules</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/deploy/index.html">Web Application Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/server/index.html">Jetty Server</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/protocols/index.html">Jetty Connectors and Protocols</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/keystore/index.html">Configuring SSL/TLS KeyStores</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/session/index.html">HTTP Session Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/quickstart/index.html">Faster Web Application Deployment</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/annotations/index.html">Annotations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/jsp/index.html">Java Server Pages</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/jstl/index.html">JavaServer Pages Standard Tag Libraries</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/jsf-taglibs/index.html">JavaServer Faces TagLibs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/jndi/index.html">JNDI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/jaas/index.html">JAAS</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/jaspi/index.html">JASPI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/jmx/index.html">JMX Monitoring &amp; Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/tools/index.html">Jetty Tools</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/troubleshooting/index.html">Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../operations-guide/xml/index.html">Jetty XML</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Programming Guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../client/index.html">Client Libraries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client/io-arch.html">I/O Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client/http.html">HTTP Client</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client/http2.html">HTTP/2 Client Library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client/http3.html">HTTP/3 Client Library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../client/websocket.html">WebSocket Client</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Server Libraries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="http.html">HTTP Server Libraries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="http2.html">HTTP/2 Server Library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="http3.html">HTTP/3 Server Library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="compliance.html">Server Compliance Modes</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="session.html">HTTP Session Management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="websocket.html">WebSocket Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="fastcgi.html">FastCGI Server Libraries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="io-arch.html">Server I/O Architecture</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Maven and Jetty</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../maven-jetty/jetty-maven-helloworld.html">Using Maven</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../maven-jetty/jetty-maven-plugin.html">Using the Jetty Maven Plugin</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../maven-jetty/jetty-jspc-maven-plugin.html">Jetty Jspc Maven Plugin</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Jetty Architecture</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../arch/bean.html">Jetty Component Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../arch/threads.html">Jetty Threading Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../arch/io.html">Jetty I/O Architecture</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../arch/listener.html">Jetty Listeners</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../arch/jmx.html">Jetty JMX Support</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../troubleshooting/index.html">Troubleshooting Jetty</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/logging.html">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/thread-dump.html">JVM Thread Dump</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/state-tracking.html"><code>StateTrackingHandler</code></a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/component-dump.html">Component Tree Dump</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/debugging.html">Remote Debugging</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Migration Guides</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../migration/94-to-10.html">Migrating from Jetty 9.4.x to Jetty 10.0.x</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../migration/11-to-12.html">Migrating from Jetty 11.0.x to Jetty 12.0.x</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Eclipse Jetty</span>
    <span class="version">12</span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../../../../contribution-guide/index.html">Contribution Guide</a></div>
    </li>
    <li class="component is-current">
      <div class="title"><a href="../../index.html">Eclipse Jetty</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">12</a>
        </li>
        <li class="version">
          <a href="../../../11/index.html">11</a>
        </li>
        <li class="version">
          <a href="../../../10/index.html">10</a>
        </li>
      </ul>
    </li>
    </li>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Eclipse Jetty</a></li>
    <li><a href="../index.html">Programming Guide</a></li>
    <li><a href="index.html">Server Libraries</a></li>
    <li><a href="session.html">HTTP Session Management</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">12</button>
  <div class="version-menu">
    <a class="version is-current" href="session.html">12</a>
    <a class="version" href="../../../11/programming-guide/server/session.html">11</a>
    <a class="version" href="../../../10/programming-guide/server/session.html">10</a>
  </div>
</div>
<div class="edit-this-page"><a href="https://github.com/jetty/jetty.project/edit/jetty-12.0.x/documentation/jetty/modules/programming-guide/pages/server/session.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Page Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">HTTP Session Management</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Sessions are a concept within the Servlet API which allow requests to store and retrieve information across the time a user spends in an application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture"><a class="anchor" href="#architecture"></a>Session Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jetty session support has been architected to provide a core implementation that is independent of the Servlet specification.
This allows programmers who use core Jetty - without the Servlet API - to still have classic Servlet session-like support for their <code>Request</code>s and <code>Handler</code>s.</p>
</div>
<div class="paragraph">
<p>These core classes are adapted to each of the various Servlet specification environments to deliver classic <code>HttpSession</code>s for <code>Servlet</code>s,`Filter``s, etc</p>
</div>
<div class="paragraph">
<p>Full support for the session lifecycle is supported, in addition to L1 and L2 caching, and a number of pluggable options for persisting session data.</p>
</div>
<div class="paragraph">
<p>Here are some of the most important concepts that will be referred to throughout the documentation:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">SessionIdManager</dt>
<dd>
<p>responsible for allocation of unique session ids.</p>
</dd>
<dt class="hdlist1">HouseKeeper</dt>
<dd>
<p>responsible for orchestrating the detection and removal of expired sessions.</p>
</dd>
<dt class="hdlist1">SessionManager</dt>
<dd>
<p>responsible for managing the lifecycle of sessions.</p>
</dd>
<dt class="hdlist1">SessionHandler</dt>
<dd>
<p>an implementation of <code>SessionManager</code> that adapts sessions to either the core or Servlet specification environment.</p>
</dd>
<dt class="hdlist1">SessionCache</dt>
<dd>
<p>an L1 cache of in-use <code>ManagedSession</code> objects</p>
</dd>
<dt class="hdlist1">Session</dt>
<dd>
<p>a session consisting of <code>SessionData</code> that can be associated with a <code>Request</code></p>
</dd>
<dt class="hdlist1">ManagedSession</dt>
<dd>
<p>a <code>Session</code> that supports caching and lifecycle management</p>
</dd>
<dt class="hdlist1">SessionData</dt>
<dd>
<p>encapsulates the attributes and metadata associated with a <code>Session</code></p>
</dd>
<dt class="hdlist1">SessionDataStore</dt>
<dd>
<p>responsible for creating, persisting and reading <code>SessionData</code></p>
</dd>
<dt class="hdlist1">CachingSessionDataStore</dt>
<dd>
<p>an L2 cache of <code>SessionData</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Diagrammatically, these concepts can be represented as:</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/plantuml/svg/eNp1ksEOwiAQRO98BenRhKhXY7y0B43xovEDNu1aSSoooF78eK1QpUt7o8Ob2WVSJ12D_IDWSq14ri9XbaVrz4WE2sCFlQ1Y-yHMAw1jUjk0Jyh_nk21AwV1e-fJtb5b3CJeB3ECB3UNqmoG-RzKMw7oBTg4OG2wS2pBqer0OrF2Dr9KRdQooJP2eLujdYz5Eng2z_hEVPqpxPecNEGF4Gjw5Lwj7mgoVGW0mbBDH5tN_9NZv-CxJX2fhF2-hKADY34s7N9yj-Y6oKTh_mcITQK7LL8ViaCDuRCr2Lzg-f5YpNg3a-wXGdE_z4ij32IBFg4=" alt="Diagram">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="idmgr"><a class="anchor" href="#idmgr"></a>The SessionIdManager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is a maximum of one <code>SessionIdManager</code> per <code>Server</code> instance.
Its purpose is to generate fresh, unique session ids and to coordinate the re-use of session ids amongst co-operating contexts.</p>
</div>
<div class="paragraph">
<p>The <code>SessionIdManager</code> is agnostic with respect to the type of clustering technology chosen.</p>
</div>
<div class="paragraph">
<p>Jetty provides a default implementation - the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/DefaultSessionIdManager.html">DefaultSessionIdManager</a>  - which should meet the needs of most users.</p>
</div>
<div class="sect2">
<h3 id="defaultidmgr"><a class="anchor" href="#defaultidmgr"></a>The DefaultSessionIdManager</h3>
<div id="workername" class="paragraph">
<p>A single instance of the <code>DefaultSessionIdManager</code> should be created and registered as a bean on the <code>Server</code> instance so that all <code>SessionHandler</code>'s share the same instance.
This is done by the Jetty <code>session</code> module, but can be done programmatically instead.
As a fallback, when an individual <code>SessionHandler</code> starts up, if it does not find the <code>SessionIdManager</code> already present for the <code>Server</code> it will create and register a bean for it.
That instance will be shared by the other <code>SessionHandler</code>s.</p>
</div>
<div class="paragraph">
<p>The most important configuration parameter for the <code>DefaultSessionIdManager</code> is the <code>workerName</code>, which uniquely identifies the server in a cluster.
If a <code>workerName</code> has not been explicitly set, then the value is derived as follows:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>node[JETTY_WORKER_NAME]</pre>
</div>
</div>
<div class="paragraph">
<p>where <code>JETTY_WORKER_NAME</code> is an environment variable whose value can be an integer or string.
If the environment variable is not set, then it defaults to <code>0</code>, yielding the default <code>workerName</code> of <code>"node0"</code>.
It is <em>essential</em> to change this default if you have more than one <code>Server</code>.</p>
</div>
<div class="paragraph">
<p>Here is an example of explicitly setting up a <code>DefaultSessionIdManager</code> with a <code>workerName</code> of <code>server3</code> in code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Server server = new Server();
DefaultSessionIdManager idMgr = new DefaultSessionIdManager(server);
//you must set the workerName unless you set the env viable JETTY_WORKER_NAME
idMgr.setWorkerName("server3");
server.addBean(idMgr, true);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="housekeeper"><a class="anchor" href="#housekeeper"></a>The HouseKeeper</h3>
<div class="paragraph">
<p>The <code>DefaultSessionIdManager</code> creates a <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/HouseKeeper.html">HouseKeeper</a>, which periodically scans for, and eliminates, expired sessions (referred to as "scavenging").
The period of the scan is controlled by the <code>setIntervalSec(int)</code> method, defaulting to 600secs.
Setting a negative or 0 value prevents scavenging occurring.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>HouseKeeper</code> semi-randomly adds 10% to the configured <code>intervalSec</code>.
This is to help prevent sync-ing up of servers in a cluster that are all restarted at once, and slightly stagger their scavenge cycles to ensure any load on the persistent storage mechanism is spread out.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is an example of creating and configuring a <code>HouseKeeper</code> for the <code>DefaultSessionIdManager</code> in code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Server server = new Server();
DefaultSessionIdManager idMgr = new DefaultSessionIdManager(server);
idMgr.setWorkerName("server7");
server.addBean(idMgr, true);

HouseKeeper houseKeeper = new HouseKeeper();
houseKeeper.setSessionIdManager(idMgr);
//set the frequency of scavenge cycles
houseKeeper.setIntervalSec(600L);
idMgr.setSessionHouseKeeper(houseKeeper);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implementing-a-custom-sessionidmanager"><a class="anchor" href="#implementing-a-custom-sessionidmanager"></a>Implementing a Custom SessionIdManager</h3>
<div class="paragraph">
<p>If the <code>DefaultSessionIdManager</code> does not meet your needs, you can extend it, or implement the <code>SessionIdManager</code> interface directly.</p>
</div>
<div class="paragraph">
<p>When implementing a <code>SessionIdManager</code> pay particular attention to the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>getWorkerName()</code> method <em>must</em> return a name that is unique to the <code>Server</code> instance.
The <code>workerName</code> becomes important in clustering scenarios because sessions can migrate from node to node:  the <code>workerName</code> identifies which node was last managing a <code>Session</code>.</p>
</li>
<li>
<p>the contract of the <code>isIdInUse(String id)</code> method is very specific: a session id may <em>only</em> be reused <em>iff</em> it is already in use by another context.
This restriction is important to support cross-context dispatch.</p>
</li>
<li>
<p>you should be <em>very</em> careful to ensure that the <code>newSessionId(HttpServletRequest request, long created)</code> method does not return duplicate or predictable session ids.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="handler"><a class="anchor" href="#handler"></a>The SessionHandler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <code>SessionHandler</code> is a <code>Handler</code> that implements the <code>SessionManager</code>, and is thus responsible for the creation, maintenance and propagation of sessions.
There are <code>SessionHandlers</code> for both the core and the various Servlet environments.</p>
</div>
<div class="paragraph">
<p>Note that in the Servlet environments, each <code>ServletContextHandler</code> or <code>WebAppContext</code> has at most a single <code>SessionHandler</code>.</p>
</div>
<div class="paragraph">
<p>Both core and Servlet environment <code>SessionHandlers</code> can be configured programmatically.
Here are some of the most important methods that you may call to customize your session setup.
Note that in Servlet environments, some of these methods also have analogous Servlet API methods and/or analogous <code>web.xml</code> declarations and also equivalent  context init params.
These alternatives are noted below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setCheckingRemoteSessionIdEncoding(boolean)  <em>[Default:false]</em> </dt>
<dd>
<p>This controls whether response urls will be encoded with the session id as a path parameter when the URL is destined for a remote node.<br>
<em>Servlet environment alternatives:</em></p>
<div class="ulist">
<ul>
<li>
<p><code>org.eclipse.jetty.session.CheckingRemoteSessionIdEncoding</code> context init parameter</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setMaxInactiveInterval(int) <em>[Default:-1]</em> </dt>
<dd>
<p>This is the amount of time in seconds after which an unused session may be scavenged.<br>
<em>Servlet environment alternatives:</em></p>
<div class="ulist">
<ul>
<li>
<p><code>&lt;session-config&gt;&lt;session-timeout/&gt;&lt;/session-config&gt;</code> element in <code>web.xml</code> (NOTE! this element is specified in <em>minutes</em> but this method uses <em>seconds</em>).</p>
</li>
<li>
<p><code>ServletContext.setSessionTimeout(int)</code> where the timeout is configured in <em>minutes</em>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setHttpOnly(boolean) <em>[Default:false]</em> </dt>
<dd>
<p>If <code>true</code>, the session cookie will not be exposed to client-side scripting code.<br>
<em>Servlet environment alternatives:</em></p>
<div class="ulist">
<ul>
<li>
<p><code>SessionCookieConfig.setHttpOnly(boolean)</code></p>
</li>
<li>
<p><code>&lt;session-config&gt;&lt;cookie-config&gt;&lt;http-only/&gt;&lt;/cookie-config&gt;&lt;/session-config&gt;</code> element in <code>web.xml</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div id="handler-refreshcookie" class="dlist">
<dl>
<dt class="hdlist1">setRefreshCookieAge(int) <em>[Default:-1]</em> </dt>
<dd>
<p>Value in seconds that controls resetting the session cookie when <code>SessionCookieConfig.setMaxAge(int)</code> is non-zero.
See also <a href="#handler-maxAge">setting the max session cookie age with an init parameter</a>.
If the amount of time since the session cookie was last set exceeds this time, the session cookie is regenerated to keep the session cookie valid.</p>
</dd>
<dt class="hdlist1">setSameSite(HttpCookie.SameSite) <em>[Default:null]</em> </dt>
<dd>
<p>The values are <code>HttpCookie.SameSite.NONE</code>, <code>HttpCookie.SameSite.STRICT</code>, <code>HttpCookie.SameSite.LAX</code>.</p>
</dd>
<dt class="hdlist1">setSecureRequestOnly(boolean) <em>[Default:true]</em></dt>
<dd>
<p>If <code>true</code> and the request is HTTPS, the set session cookie will be marked as <code>secure</code>, meaning the client will only send the session cookie to the server on subsequent requests over HTTPS.<br>
<em>Servlet environment alternatives:</em></p>
<div class="ulist">
<ul>
<li>
<p><code>SessionCookieConfig.setSecure(true)</code>, in which case the set session cookie will <em>always</em> be marked as <code>secure</code>, even if the request triggering the creation of the cookie was not over HTTPS.</p>
</li>
<li>
<p><code>&lt;session-config&gt;&lt;cookie-config&gt;&lt;secure/&gt;&lt;/cookie-config&gt;&lt;/session-config&gt;</code> element in <code>web.xml</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setSessionCookie(String) <em>[Default:"JSESSIONID"]</em></dt>
<dd>
<p>This is the name of the session cookie.<br>
<em>Servlet environment alternatives:</em></p>
<div class="ulist">
<ul>
<li>
<p><code>SessionCookieConfig.setName(String)</code></p>
</li>
<li>
<p><code>&lt;session-config&gt;&lt;cookie-config&gt;&lt;name/&gt;&lt;/cookie-config&gt;&lt;/session-config&gt;</code> element in <code>web.xml</code></p>
</li>
<li>
<p><code>org.eclipse.jetty.session.SessionCookie</code> context init parameter.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setSessionIdPathParameterName(String) <em>[Default:"jsessionid"]</em></dt>
<dd>
<p>This is the name of the path parameter used to transmit the session id on request URLs, and on encoded URLS in responses.<br>
<em>Servlet environment alternatives:</em></p>
<div class="ulist">
<ul>
<li>
<p><code>org.eclipse.jetty.session.SessionIdPathParameterName</code> context init parameter</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setSessionTrackingModes(Set&lt;SessionTrackingMode&gt;) <em>[Default:{<code>SessionTrackingMode.COOKIE</code>, <code>SessionTrackingMode.URL</code>}]</em></dt>
<dd>
<p><em>Servlet environment alternatives:</em></p>
<div class="ulist">
<ul>
<li>
<p><code>ServletContext.setSessionTrackingModes&lt;Set&lt;SessionTrackingMode&gt;)</code></p>
</li>
<li>
<p>defining up to three <code>&lt;tracking-mode&gt;</code>s for the <code>&lt;session-config&gt;</code> element in <code>web.xml</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setUsingCookies(boolean) <em>[Default:true]</em> </dt>
<dd>
<p>Determines whether the <code>SessionHandler</code> will look for session cookies on requests, and will set session cookies on responses.
If <code>false</code> session ids must be transmitted as path params on URLs.</p>
</dd>
</dl>
</div>
<div id="handler-maxAge" class="dlist">
<dl>
<dt class="hdlist1">setMaxAge(int) <em>[Default:-1]</em></dt>
<dd>
<p>This is the maximum number of seconds that the session cookie will be considered to be valid.
By default, the cookie has no maximum validity time.
See also <a href="#handler-refreshcookie">refreshing the session cookie</a>.<br>
<em>Servlet environment alternatives:</em></p>
<div class="ulist">
<ul>
<li>
<p><code>ServletContext.getSessionCookieConfig().setMaxAge(int)</code></p>
</li>
<li>
<p><code>org.eclipse.jetty.session.MaxAge</code> context init parameter</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setSessionDomain(String) <em>[Default:null]</em> </dt>
<dd>
<p>This is the domain of the session cookie.<br>
<em>Servlet environment alternatives:</em></p>
<div class="ulist">
<ul>
<li>
<p><code>ServletContext.getSessionCookieConfig().setDomain(String)</code></p>
</li>
<li>
<p><code>&lt;session-config&gt;&lt;cookie-config&gt;&lt;domain/&gt;&lt;/cookie-config&gt;&lt;/session-config&gt;</code> element in <code>web.xml</code></p>
</li>
<li>
<p><code>org.eclipse.jetty.session.SessionDomain</code> context init parameter</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setSessionPath(String) <em>[Default:null]</em></dt>
<dd>
<p>This is used when creating a new session cookie.
If nothing is configured, the context path is used instead, defaulting to <code>/</code>.<br>
<em>Servlet environment alternatives:</em></p>
<div class="ulist">
<ul>
<li>
<p><code>ServletContext.getSessionCookieConfig().setPath(String)</code></p>
</li>
<li>
<p><code>&lt;session-config&gt;&lt;cookie-config&gt;&lt;path/&gt;&lt;/cookie-config&gt;&lt;/session-config&gt;</code> element in <code>web.xml</code></p>
</li>
<li>
<p><code>org.eclipse.jetty.session.SessionPath</code> context init parameter</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="statistics"><a class="anchor" href="#statistics"></a>Statistics</h3>
<div class="paragraph">
<p>Some statistics about the sessions for a context can be obtained from the <code>SessionHandler</code>, either by calling the methods directly or via JMX:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">getSessionsCreated()</dt>
<dd>
<p>This is the total number of sessions that have been created for this context since Jetty started.</p>
</dd>
<dt class="hdlist1">getSessionTimeMax()</dt>
<dd>
<p>The longest period of time a session was valid in this context before being invalidated.</p>
</dd>
<dt class="hdlist1">getSessionTimeMean()</dt>
<dd>
<p>The average period of time a session in this context was valid.</p>
</dd>
<dt class="hdlist1">getSessionTimeStdDev()</dt>
<dd>
<p>The standard deviation of the session validity times for this context.</p>
</dd>
<dt class="hdlist1">getSessionTimeTotal()</dt>
<dd>
<p>The total time that all sessions in this context have remained valid.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cache"><a class="anchor" href="#cache"></a>The SessionCache</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is one <code>SessionCache</code> per <code>SessionManager</code>, and thus one per context.
Its purpose is to provide an L1 cache of <code>ManagedSession</code> objects.
Having a working set of <code>ManagedSession</code> objects in memory allows multiple simultaneous requests for the same session (ie the <em>same</em> session id in the <em>same</em> context) to share the same <code>ManagedSession</code> object.
A <code>SessionCache</code> uses a <code>SessionDataStore</code> to create, read, store, and delete the <code>SessionData</code> associated with the <code>ManagedSession</code>.</p>
</div>
<div class="paragraph">
<p>There are two ways to create a <code>SessionCache</code> for a <code>SessionManager</code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>allow the <code>SessionManager</code> to create one lazily at startup.
The <code>SessionManager</code> looks for a <code>SessionCacheFactory</code> bean on the <code>Server</code> to produce the <code>SessionCache</code> instance.
It then looks for a <code>SessionDataStoreFactory</code> bean on the <code>Server</code> to produce a <code>SessionDataStore</code> instance to use with the <code>SessionCache</code>.
If no <code>SessionCacheFactory</code>  is present, it defaults to creating a <code>DefaultSessionCache</code>.
If no <code>SessionDataStoreFactory</code> is present, it defaults to creating a <code>NullSessionDataStore</code>.</p>
</li>
<li>
<p>pass a fully configured <code>SessionCache</code> instance to the <code>SessionManager</code>.
You are responsible for configuring both the <code>SessionCache</code> instance and its <code>SessionDataStore</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>More on <code>SessionDataStore</code>s <a href="#datastore">later</a>, this section concentrates on the <code>SessionCache</code> and <code>SessionCacheFactory</code>.</p>
</div>
<div class="paragraph">
<p>The <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/AbstractSessionCache.html">AbstractSessionCache</a> provides most of the behaviour of <code>SessionCache</code>s.
If you are implementing a custom <code>SessionCache</code> it is strongly recommended that you extend this class because it implements the numerous subtleties  of the Servlet specification.</p>
</div>
<div class="paragraph">
<p>Some of the important behaviours of <code>SessionCache</code>s are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">eviction</dt>
<dd>
<p>By default, <code>ManagedSession</code>s remain in a cache until they are expired or invalidated.
If you have many or large sessions that are infrequently referenced you can use eviction to reduce the memory consumed by the cache.
When a session is evicted, it is removed from the cache but it is <em>not</em> invalidated.
If you have configured a <code>SessionDataStore</code> that persists or distributes the session in some way, it will continue to exist, and can be read back in when it needs to be referenced again.
The eviction strategies are:</p>
<div class="dlist">
<dl>
<dt class="hdlist1">NEVER_EVICT</dt>
<dd>
<p>This is the default, sessions remain in the cache until expired or invalidated.</p>
</dd>
<dt class="hdlist1">EVICT_ON_SESSION_EXIT</dt>
<dd>
<p>When the last simultaneous request for a session finishes, the session will be evicted from the cache.</p>
</dd>
<dt class="hdlist1">EVICT_ON_INACTIVITY</dt>
<dd>
<p>If a session has not been referenced for a configurable number of seconds, then it will be evicted from the cache.</p>
</dd>
</dl>
</div>
</dd>
<dt class="hdlist1">saveOnInactiveEviction</dt>
<dd>
<p>This controls whether a session will be persisted to the <code>SessionDataStore</code> if it is being evicted due to the EVICT_ON_INACTIVITY policy.
Usually sessions are written to the <code>SessionDataStore</code> whenever the last simultaneous request exits the session.
However, as <code>SessionDataStore</code>s` can be configured to <a href="#datastore-skip">skip some writes</a>, this option ensures that the session will be written out.</p>
</dd>
<dt class="hdlist1">saveOnCreate</dt>
<dd>
<p>Usually a session will be written through to the configured <code>SessionDataStore</code> when the last request for it finishes.
In the case of a freshly created session, this means that it will not be persisted until the request is fully finished.
If your application uses context forwarding or including, the newly created session id will not be available in the subsequent contexts.
You can enable this feature to ensure that a freshly created session is immediately persisted after creation: in this way the session id will be available for use in other contexts accessed during the same request.</p>
</dd>
<dt class="hdlist1">removeUnloadableSessions</dt>
<dd>
<p>If a session becomes corrupted in the persistent store, it cannot be re-loaded into the <code>SessionCache</code>.
This can cause noisy log output during scavenge cycles, when the same corrupted session fails to load over and over again.
To prevent his, enable this feature and the <code>SessionCache</code> will ensure that if a session fails to be loaded, it will be deleted.</p>
</dd>
<dt class="hdlist1">invalidateOnShutdown</dt>
<dd>
<p>Some applications want to ensure that all cached sessions are removed when the server shuts down.
This option will ensure that all cached sessions are invalidated.
The <code>AbstractSessionCache</code> does not implement this behaviour, a subclass must implement the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/SessionCache.html#shutdown()">SessionCache.shutdown()</a> method.</p>
</dd>
<dt class="hdlist1">flushOnResponseCommit</dt>
<dd>
<p>This forces a "dirty" session to be written to the <code>SessionDataStore</code> just before a response is returned to the client, rather than waiting until the request is finished.
A "dirty" session is one whose attributes have changed, or it has been freshly created.
Using this option ensures that all subsequent requests - either to the same or a different node - will see the latest changes to the session.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Jetty provides two <code>SessionCache</code> implementations: the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/DefaultSessionCache.html">DefaultSessionCache</a> and the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/NullSessionCache.html">NullSessionCache</a>.</p>
</div>
<div class="sect2">
<h3 id="hash"><a class="anchor" href="#hash"></a>The DefaultSessionCache</h3>
<div class="paragraph">
<p>The <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/DefaultSessionCache.html">DefaultSessionCache</a> retains <code>ManagedSession</code> objects in memory in a <code>ConcurrentHashMap</code>.
It is suitable for non-clustered and clustered deployments.
For clustered deployments, a sticky load balancer is <strong>strongly</strong> recommended, otherwise you risk indeterminate session state as the session bounces around multiple nodes.</p>
</div>
<div class="paragraph">
<p>It implements the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/SessionCache.html#shutdown()">SessionCache.shutdown()</a> method.</p>
</div>
<div class="paragraph">
<p>It also provides some statistics on sessions, which are convenient to access either directly in code or remotely via JMX:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">current sessions</dt>
<dd>
<p>The <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/DefaultSessionCache.html#getSessionsCurrent()">DefaultSessionCache.getSessionsCurrent()</a> method reports the number of sessions in the cache at the time of the method call.</p>
</dd>
<dt class="hdlist1">max sessions</dt>
<dd>
<p>The <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/DefaultSessionCache.html#getSessionsCurrent()">DefaultSessionCache.getSessionsMax()</a> method reports the highest number of sessions in the cache at the time of the method call.</p>
</dd>
<dt class="hdlist1">total sessions</dt>
<dd>
<p>The <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/DefaultSessionCache.html#getSessionsTotal()">DefaultSessionCache.getSessionsTotal()</a> method reports the cumulative total of the number of sessions in the cache at the time of the method call.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If you create a <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/DefaultSessionCacheFactory.html">DefaultSessionFactory</a> and register it as a <code>Server</code> bean, a <code>SessionManger</code> will be able to lazily create a <code>DefaultSessionCache</code>.
The <code>DefaultSessionCacheFactory</code> has all of the same configuration setters as a <code>DefaultSessionCache</code>.
Alternatively, if you only have a single <code>SessionManager</code>, or you need to configure a <code>DefaultSessionCache</code> differently for every <code>SessionManager</code>, then you could dispense with the <code>DefaultSessionCacheFactory</code> and simply instantiate, configure, and pass in the <code>DefaultSessionCache</code> yourself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Server server = new Server();

DefaultSessionCacheFactory cacheFactory = new DefaultSessionCacheFactory();
//EVICT_ON_INACTIVE: evict a session after 60sec inactivity
cacheFactory.setEvictionPolicy(60);
//Only useful with the EVICT_ON_INACTIVE policy
cacheFactory.setSaveOnInactiveEviction(true);
cacheFactory.setFlushOnResponseCommit(true);
cacheFactory.setInvalidateOnShutdown(false);
cacheFactory.setRemoveUnloadableSessions(true);
cacheFactory.setSaveOnCreate(true);

//Add the factory as a bean to the server, now whenever a
//SessionManager starts it will consult the bean to create a new DefaultSessionCache
server.addBean(cacheFactory);</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t configure any <code>SessionCache</code> or <code>SessionCacheFactory</code>, a <code>SessionManager</code> will automatically create its own <code>DefaultSessionCache</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="null"><a class="anchor" href="#null"></a>The NullSessionCache</h3>
<div class="paragraph">
<p>The <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/NullSessionCache.html">NullSessionCache</a> does not actually cache any objects: each request uses a fresh <code>ManagedSession</code> object.
It is suitable for clustered deployments without a sticky load balancer and non-clustered deployments when purely minimal support for sessions is needed.</p>
</div>
<div class="paragraph">
<p>As no sessions are actually cached, of course functions like <code>invalidateOnShutdown</code> and all of the eviction strategies have no meaning for the <code>NullSessionCache</code>.</p>
</div>
<div class="paragraph">
<p>There is a <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/NullSessionCacheFactory.html">NullSessionCacheFactory</a> which you can instantiate, configure and set as a <code>Server</code> bean to enable a <code>SessionManager</code> to automatically create new <code>NullSessionCache</code>s as needed.
All of the same configuration options are available on the <code>NullSessionCacheFactory</code> as the <code>NullSessionCache</code> itself.
Alternatively, if you only have a single <code>SessionManager</code>, or you need to configure a <code>NullSessionCache</code> differently for every <code>SessionManager</code>, then you could dispense with the <code>NullSessionCacheFactory</code> and simply instantiate, configure, and pass in the <code>NullSessionCache</code> yourself.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Server server = new Server();
NullSessionCacheFactory cacheFactory = new NullSessionCacheFactory();
cacheFactory.setFlushOnResponseCommit(true);
cacheFactory.setRemoveUnloadableSessions(true);
cacheFactory.setSaveOnCreate(true);

//Add the factory as a bean to the server, now whenever a
//SessionManager starts it will consult the bean to create a new NullSessionCache
server.addBean(cacheFactory);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="customcache"><a class="anchor" href="#customcache"></a>Implementing a custom SessionCache</h3>
<div class="paragraph">
<p>As previously mentioned, it is strongly recommended that you extend the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/AbstractSessionCache.html">AbstractSessionCache</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="heterogeneous-caching"><a class="anchor" href="#heterogeneous-caching"></a>Heterogeneous caching</h3>
<div class="paragraph">
<p>Using one of the <code>SessionCacheFactory</code>s will ensure that every time a <code>SessionManager</code> starts it will create a new instance of the corresponding type of <code>SessionCache</code>.</p>
</div>
<div class="paragraph">
<p>But, what if you deploy multiple webapps, and for one of them, you don&#8217;t want to use sessions?
Or alternatively, you don&#8217;t want to use sessions, but you have one webapp that now needs them?
In that case, you can configure the <code>SessionCacheFactory</code> appropriate to the majority, and then specifically create the right type of <code>SessionCache</code> for the others.
Here&#8217;s an example where we configure the <code>DefaultSessionCacheFactory</code> to handle most webapps, but then specifically use a <code>NullSessionCache</code> for another:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Server server = new Server();

DefaultSessionCacheFactory cacheFactory = new DefaultSessionCacheFactory();
//NEVER_EVICT
cacheFactory.setEvictionPolicy(SessionCache.NEVER_EVICT);
cacheFactory.setFlushOnResponseCommit(true);
cacheFactory.setInvalidateOnShutdown(false);
cacheFactory.setRemoveUnloadableSessions(true);
cacheFactory.setSaveOnCreate(true);

//Add the factory as a bean to the server, now whenever a
//SessionManager starts it will consult the bean to create a new DefaultSessionCache
server.addBean(cacheFactory);

ContextHandlerCollection contexts = new ContextHandlerCollection();
server.setHandler(contexts);

//Add a webapp that will use a DefaultSessionCache via the DefaultSessionCacheFactory
WebAppContext app1 = new WebAppContext();
app1.setContextPath("/app1");
contexts.addHandler(app1);

//Add a webapp that uses an explicit NullSessionCache instead
WebAppContext app2 = new WebAppContext();
app2.setContextPath("/app2");
NullSessionCache nullSessionCache = new NullSessionCache(app2.getSessionHandler());
nullSessionCache.setFlushOnResponseCommit(true);
nullSessionCache.setRemoveUnloadableSessions(true);
nullSessionCache.setSaveOnCreate(true);
//If we pass an existing SessionCache instance to the SessionHandler, it must be
//fully configured: this means we must also provide SessionDataStore
nullSessionCache.setSessionDataStore(new NullSessionDataStore());
app2.getSessionHandler().setSessionCache(nullSessionCache);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="datastore"><a class="anchor" href="#datastore"></a>The SessionDataStore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/SessionDataStore.html">SessionDataStore</a> mediates the storage, retrieval and deletion of <code>SessionData</code>.
There is one <code>SessionDataStore</code> per <code>SessionCache</code> and thus one per context.
Jetty provides a number of alternative <code>SessionDataStore</code> implementations:</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/plantuml/svg/eNp9kT0OwjAMRvecIhfoDVigFX8SLD2BCWmxZDkodpeKwzOw0dhrnp8ivU9RKccxi2DhARRGLTVLCMia6wRpC0MiEIn7h2iFpAa-L0QGOiJlA516KsvTgGdYMyUQ68sLT8gob2Dj4DocegPdCs_FYD2kF_K8oSH8P8Xdp-vsMhb4ac1ivtIs6StGYV-yy_ues4gvNpfylfaC7Vtj0S-DfCO7" alt="Diagram">
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">NullSessionDataStore</dt>
<dd>
<p>Does not store <code>SessionData</code>, meaning that sessions will exist in-memory only.
See <a href="#datastore-null">NullSessionDataStore</a></p>
</dd>
<dt class="hdlist1">FileSessionDataStore</dt>
<dd>
<p>Uses the file system to persist <code>SessionData</code>.
See <a href="#datastore-file">FileSessionDataStore</a> for more information.</p>
</dd>
<dt class="hdlist1">GCloudSessionDataStore</dt>
<dd>
<p>Uses GCloud Datastore for persisting <code>SessionData</code>.
See <a href="#datastore-gcloud">GCloudSessionDataStore</a> for more information.</p>
</dd>
<dt class="hdlist1">HazelcastSessionDataStore</dt>
<dd>
<p>Uses Hazelcast for persisting <code>SessionData</code>.</p>
</dd>
<dt class="hdlist1">InfinispanSessionDataStore</dt>
<dd>
<p>Uses <a href="http://infinispan.org">Infinispan</a> for persisting <code>SessionData</code>.
See <a href="#datastore-infinispan">InfinispanSessionDataStore</a> for more information.</p>
</dd>
<dt class="hdlist1">JDBCSessionDataStore</dt>
<dd>
<p>Uses a relational database via JDBC API to persist <code>SessionData</code>.
See <a href="#datastore-jdbc">JDBCSessionDataStore</a> for more information.</p>
</dd>
<dt class="hdlist1">MongoSessionDataStore</dt>
<dd>
<p>Uses <a href="http://www.mongodb.com">MongoDB</a> document database to persist <code>SessionData</code>.
See <a href="#datastore-mongo">MongoSessionDataStore</a> for more information.</p>
</dd>
<dt class="hdlist1">CachingSessionDataStore</dt>
<dd>
<p>Uses <a href="http://memcached.org">memcached</a> to provide an L2 cache of <code>SessionData</code> while delegating to another <code>SessionDataStore</code> for persistence of <code>SessionData</code>.
See <a href="#cachingsessiondatastore">CachingSessionDataStore</a> for more information.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Most of the behaviour common to <code>SessionDataStore</code>s is provided by the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/AbstractSessionDataStore.html">AbstractSessionDataStore</a> class.
You are strongly encouraged to use this as the base class for implementing your custom <code>SessionDataStore</code>.</p>
</div>
<div class="paragraph">
<p>Some important methods are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">isPassivating()</dt>
<dd>
<p>Boolean. "True" means that session data is <em>serialized</em>.
Some persistence mechanisms serialize, such as JDBC, GCloud Datastore etc.
Others can store an object in shared memory, e.g. Infinispan and thus don&#8217;t serialize session data.
In Servlet environments, whether a <code>SessionDataStore</code> reports that it is capable of passivating controls whether <code>HttpSessionActivationListener</code>s will be called.
When implementing a custom <code>SessionDataStore</code> you need to decide whether you will support passivation or not.</p>
</dd>
</dl>
</div>
<div id="datastore-skip" class="dlist">
<dl>
<dt class="hdlist1">setSavePeriodSec(int) <em>[Default:0]</em> </dt>
<dd>
<p>This is an interval defined in seconds.
It is used to reduce the frequency with which <code>SessionData</code> is written.
Normally, whenever the last concurrent request leaves a <code>Session</code>, the <code>SessionData</code> for that <code>Session</code> is always persisted, even if the only thing that changed is the <code>lastAccessTime</code>.
If the <code>savePeriodSec</code> is non-zero, the <code>SessionData</code> will not be persisted if no session attributes changed, <em>unless</em> the time since the last save exceeds the <code>savePeriod</code>.
Setting a non-zero value can reduce the load on the persistence mechanism, but in a clustered environment runs the risk that other nodes will see the session as expired because it has not been persisted sufficiently recently.</p>
</dd>
<dt class="hdlist1">setGracePeriodSec(int) <em>[Default:3600]</em> </dt>
<dd>
<p>The <code>gracePeriod</code> is an interval defined in seconds.
It is an attempt to deal with the non-transactional nature of sessions with regard to finding sessions that have expired.
In a clustered configuration - even with a sticky load balancer - it is always possible that a session is "live" on a node but not yet updated in the persistent store.
This means that it can be hard to determine at any given moment whether a clustered session has truly expired.
Thus, we use the <code>gracePeriod</code> to provide a bit of leeway around the moment of expiry during <a href="#housekeeper">scavenging</a>:</p>
<div class="ulist">
<ul>
<li>
<p>on every <a href="#housekeeper">scavenge</a> cycle an <code>AbstractSessionDataStore</code> searches for sessions that belong to the context that expired at least one <code>gracePeriod</code> ago</p>
</li>
<li>
<p>infrequently the <code>AbstractSessionDataStore</code> searches for and summarily deletes sessions - from any context - that expired at least 10 <code>gracePeriod</code>s ago</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="custom-sessiondatastores"><a class="anchor" href="#custom-sessiondatastores"></a>Custom SessionDataStores</h3>
<div class="paragraph">
<p>When implementing a <code>SessionDataStore</code> for a particular persistence technology, you should base it off the <code>AbstractSessionDataStore</code> class.</p>
</div>
<div class="paragraph">
<p>Firstly, it is important to understand the components of a unique key for a session suitable for storing in a persistence mechanism.
Consider that although multiple contexts may share the <em>same</em> session id (ie cross-context dispatch), the data in those sessions must be distinct.
Therefore, when storing session data in a persistence mechanism that is shared by many nodes in a cluster, the session must be identified by a combination of the id <em>and</em> the context.</p>
</div>
<div class="paragraph">
<p>The <code>SessionDataStore</code>s use the following information to synthesize a unique key for session data that is suitable to the particular persistence mechanism :</p>
</div>
<div id="key" class="dlist">
<dl>
<dt class="hdlist1">id</dt>
<dd>
<p>This is the id as generated by the <code>SessionIdManager</code></p>
</dd>
<dt class="hdlist1">context</dt>
<dd>
<p>The path of the context associated with the session.</p>
</dd>
<dt class="hdlist1">virtual host</dt>
<dd>
<p>The first virtual host - if any - associated with the context.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/SessionContext.html">SessionContext</a> class, of which every <code>AbstractSessionDataStore</code> has an instance, will provide these components to you in a canonicalized form.</p>
</div>
<div class="paragraph">
<p>Then you will need to implement the following methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">public boolean doExists(String id)</dt>
<dd>
<p>Check if data for the given session exists in your persistence mechanism.
The id is always relative to the context, see <a href="#key">above</a>.</p>
</dd>
<dt class="hdlist1">public void doStore(String id, SessionData data, long lastSaveTime)</dt>
<dd>
<p>Store the session data into your persistence mechanism.
The id is always relative to the context, see <a href="#key">above</a>.</p>
</dd>
<dt class="hdlist1">public SessionData doLoad(String id)</dt>
<dd>
<p>Load the session from your persistent mechanism.
The id is always relative to the context, see <a href="#key">above</a>.</p>
</dd>
<dt class="hdlist1">public Set&lt;String&gt; doCheckExpired(Set&lt;String&gt; candidates, long time)</dt>
<dd>
<p>Verify which of the suggested session ids have expired since the time given, according to the data stored in your persistence mechanism.
This is used during scavenging to ensure that a session that is a candidate for expiry according to <em>this</em> node is not in-use on <em>another</em> node.
The sessions matching these ids will be loaded as <code>ManagedSession</code>s and have their normal expiration lifecycle events invoked.
The id is always relative to the context, see <a href="#key">above</a>.</p>
</dd>
<dt class="hdlist1">public Set&lt;String&gt; doGetExpired(long before)</dt>
<dd>
<p>Find the ids of sessions that expired at or before the time given.
The sessions matching these ids will be loaded as <code>ManagedSession</code>s and have their normal expiration lifecycle events invoked.
The id is always relative to the context, see <a href="#key">above</a>.</p>
</dd>
<dt class="hdlist1">public void doCleanOrphans(long time)</dt>
<dd>
<p>Find the ids of sessions that expired at or before the given time, <em>independent of the context they are in</em>.
The purpose is to find sessions that are no longer being managed by any node.
These sessions may even belong to contexts that no longer exist.
Thus, any such sessions must be summarily deleted from the persistence mechanism and cannot have their normal expiration lifecycle events invoked.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="the-sessiondatastorefactory"><a class="anchor" href="#the-sessiondatastorefactory"></a>The SessionDataStoreFactory</h3>
<div class="paragraph">
<p>Every <code>SessionDataStore</code> has a factory class that creates instances based on common configuration.</p>
</div>
<div class="paragraph">
<p>All <code>SessionDataStoreFactory</code> implementations support configuring:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setSavePeriodSec(int)</dt>
<dt class="hdlist1">setGracePeriodSec(int)</dt>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="datastore-null"><a class="anchor" href="#datastore-null"></a>The NullSessionDataStore</h3>
<div class="paragraph">
<p>The <code>NullSessionDataStore</code> is a trivial implementation of <code>SessionDataStore</code> that does not persist <code>SessionData</code>.
Use it when you want your sessions to remain in memory <em>only</em>.
Be careful of your <code>SessionCache</code> when using the <code>NullSessionDataStore</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if using a <code>NullSessionCache</code> then your sessions are neither shared nor saved</p>
</li>
<li>
<p>if using a <code>DefaultSessionCache</code> with eviction settings, your session will cease to exist when it is evicted from the cache</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you have not configured any other <a href="#datastore">SessionDataStore</a>, when a <code>SessionHandler</code> aka <code>AbstractSessionManager</code> starts up, it will instantiate a <code>NullSessionDataStore</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="datastore-file"><a class="anchor" href="#datastore-file"></a>The FileSessionDataStore</h3>
<div class="paragraph">
<p>The <code>FileSessionDataStore</code> supports persistent storage of session data in a filesystem.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Persisting sessions to the local file system should <strong>never</strong> be used in a clustered environment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One file represents one session in one context.</p>
</div>
<div class="paragraph">
<p>File names follow this pattern:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[expiry]_[contextpath]_[virtualhost]_[id]</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">expiry</dt>
<dd>
<p>This is the expiry time in milliseconds since the epoch.</p>
</dd>
<dt class="hdlist1">contextpath</dt>
<dd>
<p>This is the context path with any special characters, including <code>/</code>, replaced by the <code><em></code> underscore character.
For example, a context path of <code>/catalog</code> would become <code>_catalog</code>.
A context path of simply <code>/</code> becomes just <code>_</em></code>.</p>
</dd>
<dt class="hdlist1">virtualhost</dt>
<dd>
<p>This is the first virtual host associated with the context and has the form of 4 digits separated by <code>.</code> characters.
If there are no virtual hosts associated with a context, then <code>0.0.0.0</code> is used:</p>
<div class="literalblock">
<div class="content">
<pre>[digit].[digit].[digit].[digit]</pre>
</div>
</div>
</dd>
<dt class="hdlist1">id</dt>
<dd>
<p>This is the unique id of the session.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Putting all of the above together as an example, a session with an id of <code>node0ek3vx7x2y1e7pmi3z00uqj1k0</code> for the context with path <code>/test</code> with no virtual hosts and an expiry of <code>1599558193150</code> would have a file name of:</p>
</div>
<div class="paragraph">
<p><code>1599558193150__test_0.0.0.0_node0ek3vx7x2y1e7pmi3z00uqj1k0</code></p>
</div>
<div class="paragraph">
<p>You can configure either a <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/FileSessionDataStore.html">FileSessionDataStore</a> individually, or a <code>FileSessionDataStoreFactory</code> if you want multiple <code>SessionHandler</code>s to use <code>FileSessionDataStore</code>s that are identically configured.
The configuration methods are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setStoreDir(File) <em>[Default:null]</em> </dt>
<dd>
<p>This is the location for storage of session files.
If the directory does not exist at startup, it will be created.
If you use the same <code>storeDir</code> for multiple <code>SessionHandlers</code>, then the sessions for all of those contexts are stored in the same directory.
This is not a problem, as the name of the file is unique because it contains the context information.
You <em>must</em> supply a value for this, otherwise startup of the <code>FileSessionDataStore</code> will fail.</p>
</dd>
<dt class="hdlist1">deleteUnrestorableFiles(boolean) <em>[Default:false]</em> </dt>
<dd>
<p>If set to <code>true</code>, unreadable files will be deleted.
This is useful to prevent repeated logging of the same error when the <a href="#housekeeper">scavenger</a> periodically (re-)attempts to load the corrupted information for a session in order to expire it.</p>
</dd>
<dt class="hdlist1">setSavePeriodSec(int) <em>[Default:0]</em> </dt>
<dd>
<p>This is an interval defined in seconds.
It is used to reduce the frequency with which <code>SessionData</code> is written.
Normally, whenever the last concurrent request leaves a <code>Session</code>, the <code>SessionData</code> for that <code>Session</code> is always persisted, even if the only thing that changed is the <code>lastAccessTime</code>.
If the <code>savePeriodSec</code> is non-zero, the <code>SessionData</code> will not be persisted if no session attributes changed, <em>unless</em> the time since the last save exceeds the <code>savePeriod</code>.
Setting a non-zero value can reduce the load on the persistence mechanism, but in a clustered environment runs the risk that other nodes will see the session as expired because it has not been persisted sufficiently recently.</p>
</dd>
<dt class="hdlist1">setGracePeriodSec(int) <em>[Default:3600]</em> </dt>
<dd>
<p>The <code>gracePeriod</code> is an interval defined in seconds.
It is an attempt to deal with the non-transactional nature of sessions with regard to finding sessions that have expired.
In a clustered configuration - even with a sticky load balancer - it is always possible that a session is "live" on a node but not yet updated in the persistent store.
This means that it can be hard to determine at any given moment whether a clustered session has truly expired.
Thus, we use the <code>gracePeriod</code> to provide a bit of leeway around the moment of expiry during <a href="#housekeeper">scavenging</a>:</p>
<div class="ulist">
<ul>
<li>
<p>on every <a href="#housekeeper">scavenge</a> cycle an <code>AbstractSessionDataStore</code> searches for sessions that belong to the context that expired at least one <code>gracePeriod</code> ago</p>
</li>
<li>
<p>infrequently the <code>AbstractSessionDataStore</code> searches for and summarily deletes sessions - from any context - that expired at least 10 <code>gracePeriod</code>s ago</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of configuring a <code>FileSessionDataStoreFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Server server = new Server();

//First lets configure a DefaultSessionCacheFactory
DefaultSessionCacheFactory cacheFactory = new DefaultSessionCacheFactory();
//NEVER_EVICT
cacheFactory.setEvictionPolicy(SessionCache.NEVER_EVICT);
cacheFactory.setFlushOnResponseCommit(true);
cacheFactory.setInvalidateOnShutdown(false);
cacheFactory.setRemoveUnloadableSessions(true);
cacheFactory.setSaveOnCreate(true);

//Add the factory as a bean to the server, now whenever a
//SessionManager starts it will consult the bean to create a new DefaultSessionCache
server.addBean(cacheFactory);

//Now, lets configure a FileSessionDataStoreFactory
FileSessionDataStoreFactory storeFactory = new FileSessionDataStoreFactory();
storeFactory.setStoreDir(new File("/tmp/sessions"));
storeFactory.setGracePeriodSec(3600);
storeFactory.setSavePeriodSec(0);

//Add the factory as a bean on the server, now whenever a
//SessionManager starts, it will consult the bean to create a new FileSessionDataStore
//for use by the DefaultSessionCache
server.addBean(storeFactory);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s an alternate example, configuring a <code>FileSessionDataStore</code> directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//create a context
WebAppContext app1 = new WebAppContext();
app1.setContextPath("/app1");

//First, we create a DefaultSessionCache
DefaultSessionCache cache = new DefaultSessionCache(app1.getSessionHandler());
cache.setEvictionPolicy(SessionCache.NEVER_EVICT);
cache.setFlushOnResponseCommit(true);
cache.setInvalidateOnShutdown(false);
cache.setRemoveUnloadableSessions(true);
cache.setSaveOnCreate(true);

//Now, we configure a FileSessionDataStore
FileSessionDataStore store = new FileSessionDataStore();
store.setStoreDir(new File("/tmp/sessions"));
store.setGracePeriodSec(3600);
store.setSavePeriodSec(0);

//Tell the cache to use the store
cache.setSessionDataStore(store);

//Tell the context to use the cache/store combination
app1.getSessionHandler().setSessionCache(cache);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="datastore-jdbc"><a class="anchor" href="#datastore-jdbc"></a>The JDBCSessionDataStore</h3>
<div class="paragraph">
<p>The <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/JDBCSessionDataStore.html">JDBCSessionDataStore</a> supports persistent storage of session data in a relational database.
To do that, it requires a <code>DatabaseAdaptor</code> that handles the differences between databases (eg Oracle, Postgres etc), and a <code>SessionTableSchema</code> that allows for the customization of table and column names.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/plantuml/svg/eNpLzkksLlbwcnFyDk4tLs7Mz3NJLEkMLskvSuVKBkuB-EmJxamOKYkFQGGoKFRxSGJSTmpwckZqbiIXFzZDFJQMlRS0dHXBNLpRBDVg2gIA9T07JQ==" alt="Diagram">
</div>
</div>
<div class="paragraph">
<p>The <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/JDBCSessionDataStore.html">JDBCSessionDataStore</a> and corresponding <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/JDBCSessionDataStoreFactory.html">JDBCSessionDataStoreFactory</a> support the following configuration:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setSavePeriodSec(int) <em>[Default:0]</em> </dt>
<dd>
<p>This is an interval defined in seconds.
It is used to reduce the frequency with which <code>SessionData</code> is written.
Normally, whenever the last concurrent request leaves a <code>Session</code>, the <code>SessionData</code> for that <code>Session</code> is always persisted, even if the only thing that changed is the <code>lastAccessTime</code>.
If the <code>savePeriodSec</code> is non-zero, the <code>SessionData</code> will not be persisted if no session attributes changed, <em>unless</em> the time since the last save exceeds the <code>savePeriod</code>.
Setting a non-zero value can reduce the load on the persistence mechanism, but in a clustered environment runs the risk that other nodes will see the session as expired because it has not been persisted sufficiently recently.</p>
</dd>
<dt class="hdlist1">setGracePeriodSec(int) <em>[Default:3600]</em> </dt>
<dd>
<p>The <code>gracePeriod</code> is an interval defined in seconds.
It is an attempt to deal with the non-transactional nature of sessions with regard to finding sessions that have expired.
In a clustered configuration - even with a sticky load balancer - it is always possible that a session is "live" on a node but not yet updated in the persistent store.
This means that it can be hard to determine at any given moment whether a clustered session has truly expired.
Thus, we use the <code>gracePeriod</code> to provide a bit of leeway around the moment of expiry during <a href="#housekeeper">scavenging</a>:</p>
<div class="ulist">
<ul>
<li>
<p>on every <a href="#housekeeper">scavenge</a> cycle an <code>AbstractSessionDataStore</code> searches for sessions that belong to the context that expired at least one <code>gracePeriod</code> ago</p>
</li>
<li>
<p>infrequently the <code>AbstractSessionDataStore</code> searches for and summarily deletes sessions - from any context - that expired at least 10 <code>gracePeriod</code>s ago</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setDatabaseAdaptor(DatabaseAdaptor)</dt>
<dd>
<p>A <code>JDBCSessionDataStore</code> requires a <code>DatabaseAdapter</code>, otherwise an <code>Exception</code>  is thrown  at start time.</p>
</dd>
<dt class="hdlist1">setSessionTableSchema(SessionTableSchema)</dt>
<dd>
<p>If a <code>SessionTableSchema</code> has not been explicitly set, one with all values defaulted is created at start time.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="the-databaseadaptor"><a class="anchor" href="#the-databaseadaptor"></a>The DatabaseAdaptor</h4>
<div class="paragraph">
<p>Many databases use different keywords for types such as <code>long</code>, <code>blob</code> and <code>varchar</code>.
Jetty will detect the type of the database at runtime by interrogating the metadata associated with a database connection.
Based on that metadata Jetty will try to select that database&#8217;s preferred keywords.
However, you may need to instead explicitly configure these as described below.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setDatasource(String)</dt>
<dt class="hdlist1">setDatasource(Datasource)</dt>
<dd>
<p>Either the JNDI name of a <code>Datasource</code> to look up, or the <code>Datasource</code> itself.
Alternatively you can set the <strong>driverInfo</strong>, see  below.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">DatabaseAdaptor datasourceAdaptor = new DatabaseAdaptor();
datasourceAdaptor.setDatasourceName("/jdbc/myDS");</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setDriverInfo(String, String)</dt>
<dt class="hdlist1">setDriverInfo(Driver, String)</dt>
<dd>
<p>This is the name or instance of a <code>Driver</code> class and a connection URL.
Alternatively you can set the <strong>datasource</strong>, see above.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">DatabaseAdaptor driverAdaptor = new DatabaseAdaptor();
driverAdaptor.setDriverInfo("com.mysql.jdbc.Driver", "jdbc:mysql://127.0.0.1:3306/sessions?user=sessionsadmin");</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setBlobType(String) <em>[Default: "blob" or "bytea" for Postgres]</em> </dt>
<dd>
<p>The type name used to represent "blobs" by the database.</p>
</dd>
<dt class="hdlist1">setLongType(String) <em>[Default: "bigint" or "number(20)" for Oracle]</em> </dt>
<dd>
<p>The type name  used to represent large integers by the database.</p>
</dd>
<dt class="hdlist1">setStringType(String) <em>[Default: "varchar"]</em></dt>
<dd>
<p>The type name used to represent character data by the database.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="the-sessiontableschema"><a class="anchor" href="#the-sessiontableschema"></a>The SessionTableSchema</h4>
<div class="paragraph">
<p><code>SessionData</code> is stored in a table with one row per session.
This is the definition of the table with the table name, column names, and type keywords all at their default settings:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table:JettySessions</caption>
<colgroup>
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3333%;">
<col style="width: 8.3337%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">sessionId</th>
<th class="tableblock halign-left valign-top">contextPath</th>
<th class="tableblock halign-left valign-top">virtualHost</th>
<th class="tableblock halign-left valign-top">lastNode</th>
<th class="tableblock halign-left valign-top">accessTime</th>
<th class="tableblock halign-left valign-top">lastAccessTime</th>
<th class="tableblock halign-left valign-top">createTime</th>
<th class="tableblock halign-left valign-top">cookieTime</th>
<th class="tableblock halign-left valign-top">lastSavedTime</th>
<th class="tableblock halign-left valign-top">expiryTime</th>
<th class="tableblock halign-left valign-top">maxInterval</th>
<th class="tableblock halign-left valign-top">map</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">120 varchar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60 varchar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60 varchar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">60 varchar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">long</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">blob</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Use the <code>SessionTableSchema</code> class to customize these names.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setSchemaName(String), setCatalogName(String) <em>[Default: null]</em> </dt>
<dd>
<p>The exact meaning of these two are dependent on your database vendor, but can broadly be described as further scoping for the session table name.
See <a href="https://en.wikipedia.org/wiki/Database_schema" class="bare">https://en.wikipedia.org/wiki/Database_schema</a> and <a href="https://en.wikipedia.org/wiki/Database_catalog" class="bare">https://en.wikipedia.org/wiki/Database_catalog</a>.
These extra scoping names come into play at startup time when Jetty determines if the session table already exists, or creates it on-the-fly.
If your database is not using schema or catalog name scoping, leave these unset.
If your database is configured with a schema or catalog name, use the special value "INFERRED" and Jetty will extract them from the database metadata.
Alternatively, set them explicitly using these methods.</p>
</dd>
<dt class="hdlist1">setTableName(String) <em>[Default:"JettySessions"]</em> </dt>
<dd>
<p>This is the name of the table in which session data is stored.</p>
</dd>
<dt class="hdlist1">setAccessTimeColumn(String) <em>[Default: "accessTime"]</em> </dt>
<dd>
<p>This is the name of the column that stores the time - in ms since the epoch - at which a session was last accessed</p>
</dd>
<dt class="hdlist1">setContextPathColumn(String) <em>[Default: "contextPath"]</em> </dt>
<dd>
<p>This is the name of the column that stores the <code>contextPath</code> of a session.</p>
</dd>
<dt class="hdlist1">setCookieTimeColumn(String) <em>[Default: "cookieTime"]</em></dt>
<dd>
<p>This is the name of the column that stores the time - in ms since the epoch - that the cookie was last set for a session.</p>
</dd>
<dt class="hdlist1">setCreateTimeColumn(String) <em>[Default: "createTime"]</em> </dt>
<dd>
<p>This is the name of the column that stores the time - in ms since the epoch - at which a session was created.</p>
</dd>
<dt class="hdlist1">setExpiryTimeColumn(String) <em>[Default: "expiryTime"]</em> </dt>
<dd>
<p>This is name of the column that stores - in ms since the epoch - the time at which a session will expire.</p>
</dd>
<dt class="hdlist1">setLastAccessTimeColumn(String) <em>[Default: "lastAccessTime"]</em> </dt>
<dd>
<p>This is the name of the column that stores the time - in ms since the epoch - that a session was previously accessed.</p>
</dd>
<dt class="hdlist1">setLastSavedTimeColumn(String) <em>[Default: "lastSavedTime"]</em> </dt>
<dd>
<p>This is the name of the column that stores the time - in ms since the epoch - at which a session was last written.</p>
</dd>
<dt class="hdlist1">setIdColumn(String) <em>[Default: "sessionId"]</em> </dt>
<dd>
<p>This is the name of the column that stores the id of a session.</p>
</dd>
<dt class="hdlist1">setLastNodeColumn(String) <em>[Default: "lastNode"]</em> </dt>
<dd>
<p>This is the name of the column that stores the <code>workerName</code> of the last node to write a session.</p>
</dd>
<dt class="hdlist1">setVirtualHostColumn(String) <em>[Default: "virtualHost"]</em> </dt>
<dd>
<p>This is the name of the column that stores the first virtual host of the context of a session.</p>
</dd>
<dt class="hdlist1">setMaxIntervalColumn(String) <em>[Default: "maxInterval"]</em> </dt>
<dd>
<p>This is the name of the column that stores the interval - in ms - during which a session can be idle before being considered expired.</p>
</dd>
<dt class="hdlist1">setMapColumn(String) <em>[Default: "map"]</em> </dt>
<dd>
<p>This is the name of the column that stores the serialized attributes of a session.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="datastore-mongo"><a class="anchor" href="#datastore-mongo"></a>The MongoSessionDataStore</h3>
<div class="paragraph">
<p>The <code>MongoSessionDataStore</code> supports persistence of <code>SessionData</code> in a nosql database.</p>
</div>
<div class="paragraph">
<p>The best description for the document model for session information is found in the javadoc for the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/nosql/mongodb/MongoSessionDataStore.html">MongoSessionDataStore</a>.
In overview, it can be represented thus:</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/plantuml/svg/eNpVyUEKgCAQRuG9pxg8TftOMOkUhmg4f1CEd0_IgjZv8T3P4IlVaAC2UVRDTkqXIZpz9FJoFeD8jbZCFNLHOnW0LifIAfsxUREHTku7DJQw7RDts5q31dQbsAIrCQ==" alt="Diagram">
</div>
</div>
<div class="paragraph">
<p>The database contains a document collection for the sessions.
Each document represents a session id, and contains one nested document per context in which that session id is used.
For example, the session id <code>abcd12345</code> might be used by two contexts, one with path <code>/contextA</code> and one with path <code>/contextB</code>.
In that case, the outermost document would refer to <code>abcd12345</code> and it would have a nested document for <code>/contextA</code> containing the session attributes for that context, and another nested document for <code>/contextB</code> containing the session attributes for that context.
Remember, according to the Servlet Specification, a session id can be shared by many contexts, but the attributes must be unique per context.</p>
</div>
<div class="paragraph">
<p>The outermost document contains these fields:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">id</dt>
<dd>
<p>The session id.</p>
</dd>
<dt class="hdlist1">created</dt>
<dd>
<p>The time (in ms since the epoch) at which the session was first created in any context.</p>
</dd>
<dt class="hdlist1">maxIdle</dt>
<dd>
<p>The time (in ms) for which an idle session is regarded as valid.
As maxIdle times can be different for <code>Session</code>s from different contexts, this is the <em>shortest</em> maxIdle time.</p>
</dd>
<dt class="hdlist1">expiry</dt>
<dd>
<p>The time (in ms since the epoch) at which the session will expire.
As the expiry time can be different for <code>Session</code>s from different contexts, this is the <em>shortest</em> expiry time.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Each nested context-specific document contains:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">attributes</dt>
<dd>
<p>The session attributes as a serialized map.</p>
</dd>
<dt class="hdlist1">lastSaved</dt>
<dd>
<p>The time (in ms since the epoch) at which the session in this context was saved.</p>
</dd>
<dt class="hdlist1">lastAccessed</dt>
<dd>
<p>The time (in ms since the epoch) at which the session in this context was previously accessed.</p>
</dd>
<dt class="hdlist1">accessed</dt>
<dd>
<p>The time (in ms since the epoch) at which this session was most recently accessed.</p>
</dd>
<dt class="hdlist1">lastNode</dt>
<dd>
<p>The <a href="#workername">workerName</a> of the last server that saved the session data.</p>
</dd>
<dt class="hdlist1">version</dt>
<dd>
<p>An object that is updated every time a session is written for a context.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You can configure either a <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/nosql/mongodb/MongoSessionDataStore.html">MongoSessionDataStore</a> individually, or a <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/nosql/mongodb/MongoSessionDataStoreFactory.html">MongoSessionDataStoreFactory</a> if you want multiple <code>SessionHandler</code>s to use <code>MongoSessionDataStore</code>s that are identically configured.
The configuration methods for the <code>MongoSessionDataStoreFactory</code> are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setSavePeriodSec(int) <em>[Default:0]</em> </dt>
<dd>
<p>This is an interval defined in seconds.
It is used to reduce the frequency with which <code>SessionData</code> is written.
Normally, whenever the last concurrent request leaves a <code>Session</code>, the <code>SessionData</code> for that <code>Session</code> is always persisted, even if the only thing that changed is the <code>lastAccessTime</code>.
If the <code>savePeriodSec</code> is non-zero, the <code>SessionData</code> will not be persisted if no session attributes changed, <em>unless</em> the time since the last save exceeds the <code>savePeriod</code>.
Setting a non-zero value can reduce the load on the persistence mechanism, but in a clustered environment runs the risk that other nodes will see the session as expired because it has not been persisted sufficiently recently.</p>
</dd>
<dt class="hdlist1">setGracePeriodSec(int) <em>[Default:3600]</em> </dt>
<dd>
<p>The <code>gracePeriod</code> is an interval defined in seconds.
It is an attempt to deal with the non-transactional nature of sessions with regard to finding sessions that have expired.
In a clustered configuration - even with a sticky load balancer - it is always possible that a session is "live" on a node but not yet updated in the persistent store.
This means that it can be hard to determine at any given moment whether a clustered session has truly expired.
Thus, we use the <code>gracePeriod</code> to provide a bit of leeway around the moment of expiry during <a href="#housekeeper">scavenging</a>:</p>
<div class="ulist">
<ul>
<li>
<p>on every <a href="#housekeeper">scavenge</a> cycle an <code>AbstractSessionDataStore</code> searches for sessions that belong to the context that expired at least one <code>gracePeriod</code> ago</p>
</li>
<li>
<p>infrequently the <code>AbstractSessionDataStore</code> searches for and summarily deletes sessions - from any context - that expired at least 10 <code>gracePeriod</code>s ago</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setDbName(String)</dt>
<dd>
<p>This is the name of the database.</p>
</dd>
<dt class="hdlist1">setCollectionName(String)</dt>
<dd>
<p>The name of the document collection.</p>
</dd>
<dt class="hdlist1">setConnectionString(String)</dt>
<dd>
<p>a mongodb url, eg "mongodb://localhost".
Alternatively, you can specify the <strong>host,port</strong> combination instead, see below.</p>
</dd>
<dt class="hdlist1">setHost(String)</dt>
<dt class="hdlist1">setPort(int)</dt>
<dd>
<p>the hostname and port number of the mongodb instance to contact.
Alternatively, you can specify the <strong>connectionString</strong> instead, see above.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This is an example of configuring a <code>MongoSessionDataStoreFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Server server = new Server();

MongoSessionDataStoreFactory mongoSessionDataStoreFactory = new MongoSessionDataStoreFactory();
mongoSessionDataStoreFactory.setGracePeriodSec(3600);
mongoSessionDataStoreFactory.setSavePeriodSec(0);
mongoSessionDataStoreFactory.setDbName("HttpSessions");
mongoSessionDataStoreFactory.setCollectionName("JettySessions");

// Either set the connectionString
mongoSessionDataStoreFactory.setConnectionString("mongodb:://localhost:27017");
// or alternatively set the host and port.
mongoSessionDataStoreFactory.setHost("localhost");
mongoSessionDataStoreFactory.setPort(27017);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="datastore-infinispan"><a class="anchor" href="#datastore-infinispan"></a>The InfinispanSessionDataStore</h3>
<div class="paragraph">
<p>The <code>InfinispanSessionDataStore</code> supports persistent storage of session data via the <a href="https://infinispan.org/">Infinispan</a> data grid.</p>
</div>
<div class="paragraph">
<p>You may use Infinispan in either <em>embedded mode</em>, where it runs in the same process as Jetty, or in <em>remote mode</em> mode, where your Infinispan instance is on another node.</p>
</div>
<div class="paragraph">
<p>For more information on Infinispan, including some code examples, consult the <a href="https://infinispan.org/">Infinispan documentation</a>.
See below for some code examples of configuring the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/infinispan/InfinispanSessionDataStore.html">InfinispanSessionDataStore</a> in Jetty.
Note that the configuration options are the same for both the <code>InfinispanSessionDataStore</code> and the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/infinispan/InfinispanSessionDataStoreFactory.html">InfinispanSessionDataStoreFactory</a>.
Use the latter to apply the same configuration to multiple <code>InfinispanSessionDataStore</code>s.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setSavePeriodSec(int) <em>[Default:0]</em> </dt>
<dd>
<p>This is an interval defined in seconds.
It is used to reduce the frequency with which <code>SessionData</code> is written.
Normally, whenever the last concurrent request leaves a <code>Session</code>, the <code>SessionData</code> for that <code>Session</code> is always persisted, even if the only thing that changed is the <code>lastAccessTime</code>.
If the <code>savePeriodSec</code> is non-zero, the <code>SessionData</code> will not be persisted if no session attributes changed, <em>unless</em> the time since the last save exceeds the <code>savePeriod</code>.
Setting a non-zero value can reduce the load on the persistence mechanism, but in a clustered environment runs the risk that other nodes will see the session as expired because it has not been persisted sufficiently recently.</p>
</dd>
<dt class="hdlist1">setGracePeriodSec(int) <em>[Default:3600]</em> </dt>
<dd>
<p>The <code>gracePeriod</code> is an interval defined in seconds.
It is an attempt to deal with the non-transactional nature of sessions with regard to finding sessions that have expired.
In a clustered configuration - even with a sticky load balancer - it is always possible that a session is "live" on a node but not yet updated in the persistent store.
This means that it can be hard to determine at any given moment whether a clustered session has truly expired.
Thus, we use the <code>gracePeriod</code> to provide a bit of leeway around the moment of expiry during <a href="#housekeeper">scavenging</a>:</p>
<div class="ulist">
<ul>
<li>
<p>on every <a href="#housekeeper">scavenge</a> cycle an <code>AbstractSessionDataStore</code> searches for sessions that belong to the context that expired at least one <code>gracePeriod</code> ago</p>
</li>
<li>
<p>infrequently the <code>AbstractSessionDataStore</code> searches for and summarily deletes sessions - from any context - that expired at least 10 <code>gracePeriod</code>s ago</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setCache(BasicCache&lt;String, InfinispanSessionData&gt; cache)</dt>
<dd>
<p>Infinispan uses a cache API as the interface to the data grid and this method configures Jetty with the cache instance.
This cache can be either an <em>embedded</em> cache - also called a "local" cache in Infinispan parlance - or a <em>remote</em> cache.</p>
</dd>
<dt class="hdlist1">setSerialization(boolean) <em>[Default: false]</em> </dt>
<dd>
<p>When the <code>InfinispanSessionDataStore</code> starts, if it detects the Infinispan classes for remote caches on the classpath, it will automatically assume <code>serialization</code> is true, and thus that <code>SessionData</code> will be serialized over-the-wire to a remote cache.
You can use this parameter to override this.
If this parameter is <code>true</code>, the <code>InfinispanSessionDataStore</code> returns true for the <code>isPassivating()</code> method, but false otherwise.</p>
</dd>
<dt class="hdlist1">setInfinispanIdleTimeoutSec(int) <em>[Default: 0]</em> </dt>
<dd>
<p>This controls the Infinispan option whereby it can detect and delete entries that have not been referenced for a configurable amount of time.
A value of 0 disables it.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you use this option, expired sessions will be summarily deleted from Infinispan <em>without</em> the normal session invalidation handling (eg calling of lifecycle listeners).
Only use this option if you do not have session lifecycle listeners that must be called when a session is invalidated.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setQueryManager(QueryManager)</dt>
<dd>
<p>If this parameter is not set, the <code>InfinispanSessionDataStore</code> will be unable to scavenge for unused sessions.
In that case, you can use the <code>infinispanIdleTimeoutSec</code> option instead to prevent the accumulation of expired sessions.
When using Infinispan in <em>embedded</em> mode, configure the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/infinispan/EmbeddedQueryManager.html">EmbeddedQueryManager</a> to enable Jetty to query for expired sessions so that they may be property invalidated and lifecycle listeners called.
When using Infinispan in <em>remote</em> mode, configure the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/infinispan/RemoteQueryManager.html">RemoteQueryManager</a> instead.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Here is an example of configuring an <code>InfinispanSessionDataStore</code> in code using an <em>embedded</em> cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/* Create a core SessionHandler
 * Alternatively in a Servlet Environment do:
 * WebAppContext webapp = new WebAppContext();
 * SessionHandler sessionHandler = webapp.getSessionHandler();
 */
SessionHandler sessionHandler = new SessionHandler();

//Use an Infinispan local cache configured via an infinispan xml file
DefaultCacheManager defaultCacheManager = new DefaultCacheManager("path/to/infinispan.xml");
Cache&lt;String, InfinispanSessionData&gt; localCache = defaultCacheManager.getCache();

//Configure the Jetty session datastore with Infinispan
InfinispanSessionDataStore infinispanSessionDataStore = new InfinispanSessionDataStore();
infinispanSessionDataStore.setCache(localCache);
infinispanSessionDataStore.setSerialization(false); //local cache does not serialize session data
infinispanSessionDataStore.setInfinispanIdleTimeoutSec(0); //do not use infinispan auto delete of unused sessions
infinispanSessionDataStore.setQueryManager(new org.eclipse.jetty.session.infinispan.EmbeddedQueryManager(localCache)); //enable Jetty session scavenging
infinispanSessionDataStore.setGracePeriodSec(3600);
infinispanSessionDataStore.setSavePeriodSec(0);

//Configure a SessionHandler to use the local Infinispan cache as a store of SessionData
DefaultSessionCache sessionCache = new DefaultSessionCache(sessionHandler);
sessionCache.setSessionDataStore(infinispanSessionDataStore);
sessionHandler.setSessionCache(sessionCache);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of configuring an <code>InfinispanSessionDataStore</code> in code using a <em>remote</em> cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/* Create a core SessionHandler
 * Alternatively in a Servlet Environment do:
 * WebAppContext webapp = new WebAppContext();
 * SessionHandler sessionHandler = webapp.getSessionHandler();
 */
SessionHandler sessionHandler = new SessionHandler();

//Configure Infinispan to provide a remote cache called "JettySessions"
Properties hotrodProperties = new Properties();
hotrodProperties.load(new FileInputStream("/path/to/hotrod-client.properties"));
org.infinispan.client.hotrod.configuration.ConfigurationBuilder configurationBuilder = new ConfigurationBuilder();
configurationBuilder.withProperties(hotrodProperties);
configurationBuilder.marshaller(new ProtoStreamMarshaller());
configurationBuilder.addContextInitializer(new org.eclipse.jetty.session.infinispan.InfinispanSerializationContextInitializer());
org.infinispan.client.hotrod.RemoteCacheManager remoteCacheManager = new RemoteCacheManager(configurationBuilder.build());
RemoteCache&lt;String, InfinispanSessionData&gt; remoteCache = remoteCacheManager.getCache("JettySessions");

//Configure the Jetty session datastore with Infinispan
InfinispanSessionDataStore infinispanSessionDataStore = new InfinispanSessionDataStore();
infinispanSessionDataStore.setCache(remoteCache);
infinispanSessionDataStore.setSerialization(true); //remote cache serializes session data
infinispanSessionDataStore.setInfinispanIdleTimeoutSec(0); //do not use infinispan auto delete of unused sessions
infinispanSessionDataStore.setQueryManager(new org.eclipse.jetty.session.infinispan.RemoteQueryManager(remoteCache)); //enable Jetty session scavenging
infinispanSessionDataStore.setGracePeriodSec(3600);
infinispanSessionDataStore.setSavePeriodSec(0);

//Configure a SessionHandler to use a remote Infinispan cache as a store of SessionData
DefaultSessionCache sessionCache = new DefaultSessionCache(sessionHandler);
sessionCache.setSessionDataStore(infinispanSessionDataStore);
sessionHandler.setSessionCache(sessionCache);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="datastore-gcloud"><a class="anchor" href="#datastore-gcloud"></a>The GCloudSessionDataStore</h3>
<div class="paragraph">
<p>The <code>GCloudSessionDataStore</code> supports persistent storage of session data into <a href="https://cloud.google.com/datastore">Google Cloud DataStore</a>.</p>
</div>
<div class="sect3">
<h4 id="datastore-gcloud-prep"><a class="anchor" href="#datastore-gcloud-prep"></a>Preparation</h4>
<div class="paragraph">
<p>You will first need to create a project and enable the Google Cloud API: <a href="https://cloud.google.com/docs/authentication#preparation" class="bare">https://cloud.google.com/docs/authentication#preparation</a>.
Take note of the <code>project id</code> that you create in this step as you need to supply it in later steps.</p>
</div>
<div class="paragraph">
<p>You can choose to use Jetty either inside or outside of Google infrastructure.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Outside of Google infrastructure</p>
<div class="paragraph">
<p>Before running Jetty, you will need to choose one of the following methods to set up the local environment to enable remote GCloud DataStore communications:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Using the GCloud SDK</p>
<div class="ulist">
<ul>
<li>
<p>Ensure you have the GCloud SDK installed: <a href="https://cloud.google.com/sdk/?hl=en" class="bare">https://cloud.google.com/sdk/?hl=en</a></p>
</li>
<li>
<p>Use the GCloud tool to set up the project you created in the preparation step: <code>gcloud config set project PROJECT_ID</code></p>
</li>
<li>
<p>Use the GCloud tool to authenticate a Google account associated with the project created in the preparation step: <code>gcloud auth login ACCOUNT</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Using environment variables</p>
<div class="ulist">
<ul>
<li>
<p>Define the environment variable <code>GCLOUD_PROJECT</code> with the project id you created in the preparation step.</p>
</li>
<li>
<p>Generate a JSON <a href="https://cloud.google.com/storage/docs/authentication?hl=en#service_accounts">service account key</a> and then define the environment variable <code>GOOGLE_APPLICATION_CREDENTIALS=/path/to/my/key.json</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Inside of Google infrastructure</p>
<div class="paragraph">
<p>The Google deployment tools will automatically configure the project and authentication information for you.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Jetty GCloud session support provides some indexes as optimizations that can speed up session searches.
This will particularly benefit session scavenging, although it may make write operations slower.
By default, indexes will <em>not</em> be used.
You will see a log <code>WARNING</code> message informing you about the absence of indexes:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>WARN: Session indexes not uploaded, falling back to less efficient queries</pre>
</div>
</div>
<div class="paragraph">
<p>In order to use them, you will need to manually upload the file to GCloud that defines the indexes.
This file is named <code>index.yaml</code> and you can find it in your distribution in <code>$JETTY_BASE/etc/sessions/gcloud/index.yaml</code>.</p>
</div>
<div class="paragraph">
<p>Follow the instructions <a href="https://cloud.google.com/datastore/docs/tools/#the_development_workflow_using_gcloud">here</a> to upload the pre-generated <code>index.yaml</code> file.</p>
</div>
</div>
<div class="sect3">
<h4 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h4>
<div class="paragraph">
<p>The following configuration options apply to both the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/GCloudSessionDataStore.html">GCloudSessionDataStore</a> and the <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/GCloudSessionDataStoreFactory.html">GCloudSessionDataStoreFactory</a>.
Use the latter if you want multiple <code>SessionHandler</code>s to use <code>GCloudSessionDataStore</code>s that are identically configured.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">setSavePeriodSec(int) <em>[Default:0]</em> </dt>
<dd>
<p>This is an interval defined in seconds.
It is used to reduce the frequency with which <code>SessionData</code> is written.
Normally, whenever the last concurrent request leaves a <code>Session</code>, the <code>SessionData</code> for that <code>Session</code> is always persisted, even if the only thing that changed is the <code>lastAccessTime</code>.
If the <code>savePeriodSec</code> is non-zero, the <code>SessionData</code> will not be persisted if no session attributes changed, <em>unless</em> the time since the last save exceeds the <code>savePeriod</code>.
Setting a non-zero value can reduce the load on the persistence mechanism, but in a clustered environment runs the risk that other nodes will see the session as expired because it has not been persisted sufficiently recently.</p>
</dd>
<dt class="hdlist1">setGracePeriodSec(int) <em>[Default:3600]</em> </dt>
<dd>
<p>The <code>gracePeriod</code> is an interval defined in seconds.
It is an attempt to deal with the non-transactional nature of sessions with regard to finding sessions that have expired.
In a clustered configuration - even with a sticky load balancer - it is always possible that a session is "live" on a node but not yet updated in the persistent store.
This means that it can be hard to determine at any given moment whether a clustered session has truly expired.
Thus, we use the <code>gracePeriod</code> to provide a bit of leeway around the moment of expiry during <a href="#housekeeper">scavenging</a>:</p>
<div class="ulist">
<ul>
<li>
<p>on every <a href="#housekeeper">scavenge</a> cycle an <code>AbstractSessionDataStore</code> searches for sessions that belong to the context that expired at least one <code>gracePeriod</code> ago</p>
</li>
<li>
<p>infrequently the <code>AbstractSessionDataStore</code> searches for and summarily deletes sessions - from any context - that expired at least 10 <code>gracePeriod</code>s ago</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">setProjectId(String) <em>[Default: null]</em> </dt>
<dd>
<p>Optional.
The <code>project id</code> of your project.
You don&#8217;t need to set this if you carried out the instructions in the <a href="#datastore-gcloud-prep">Preparation</a> section, but you might want to set this - along with the <code>host</code> and/or <code>namespace</code> parameters - if you want more explicit control over connecting to GCloud.</p>
</dd>
<dt class="hdlist1">setHost(String) <em>[Default: null]</em> </dt>
<dd>
<p>Optional.
This is the name of the host for the GCloud DataStore.
If you leave it unset, then the GCloud DataStore library will work out the host to contact.
You might want to use this - along with <code>projectId</code> and/or <code>namespace</code> parameters - if you want more explicit control over connecting to GCloud.</p>
</dd>
<dt class="hdlist1">setNamespace(String) <em>[Default: null]</em> </dt>
<dd>
<p>Optional.
If set, partitions the visibility of session data in multi-tenant deployments.
More information can be found <a href="https://cloud.google.com/datastore/docs/concepts/multitenancy">here.</a></p>
</dd>
<dt class="hdlist1">setMaxRetries(int) <em>[Default: 5]</em> </dt>
<dd>
<p>This is the maximum number of retries to connect to GCloud DataStore in order to write a session.
This is used in conjunction with the <code>backoffMs</code> parameter to control the frequency with which Jetty will retry to contact GCloud to write out a session.</p>
</dd>
<dt class="hdlist1">setBackoffMs(int) <em>[Default: 1000]</em> </dt>
<dd>
<p>This is the interval that Jetty will wait in between retrying failed writes.
Each time a write fails, Jetty doubles the previous backoff.
Used in conjunction with the <code>maxRetries</code> parameter.</p>
</dd>
<dt class="hdlist1">setEntityDataModel(EntityDataModel)</dt>
<dd>
<p>The <code>EntityDataModel</code> encapsulates the type (called "kind" in GCloud DataStore) of stored session objects and the names of its fields.
If you do not set this parameter, <code>GCloudSessionDataStore</code> uses all default values, which should be sufficient for most needs.
Should you need to customize this, the methods and their defaults are:</p>
<div class="ulist">
<ul>
<li>
<p><strong>setKind(String)</strong> <em>[Default: "GCloudSession"]</em> this is the type of the session object.</p>
</li>
<li>
<p><strong>setId(String)</strong> <em>[Default: "id"]</em>  this is the name of the field storing the session id.</p>
</li>
<li>
<p><strong>setContextPath(String)</strong> <em>[Default: "contextPath"]</em> this is name of the field storing the canonicalized context path of the context to which the session belongs.</p>
</li>
<li>
<p><strong>setVhost(String)</strong> <em>[Default: "vhost"]</em>  this the name of the field storing the canonicalized virtual host of the context to which the session belongs.</p>
</li>
<li>
<p><strong>setAccessed(String)</strong> <em>[Default: "accessed"]</em>  this is the name of the field storing the current access time of the session.</p>
</li>
<li>
<p><strong>setLastAccessed(String)</strong> <em>[Default: "lastAccessed"]</em> this is the name of the field storing the last access time of the session.</p>
</li>
<li>
<p><strong>setCreateTime(String)</strong> <em>[Default: "createTime"]</em> this is the name of the field storing the time in ms since the epoch, at which the session was created.</p>
</li>
<li>
<p><strong>setCookieSetTime(String)</strong> <em>[Default: "cookieSetTime"]</em> this is the name of the field storing time at which the session cookie was last set.</p>
</li>
<li>
<p><strong>setLastNode(String)</strong> <em>[Default: "lastNode"]</em> this is the name of the field storing the <code>workerName</code> of the last node to manage the session.</p>
</li>
<li>
<p><strong>setExpiry(String)</strong> <em>[Default: "expiry"]</em> this is the name of the field storing the time, in ms since the epoch, at which the session will expire.</p>
</li>
<li>
<p><strong>setMaxInactive(String)</strong> <em>[Default: "maxInactive"]</em> this is the name of the field storing the session timeout in ms.</p>
</li>
<li>
<p><strong>setAttributes(String)</strong> <em>[Default: "attributes"]</em> this is the name of the field storing the session attribute map.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of configuring a <code>GCloudSessionDataStoreFactory</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Server server = new Server();

//Ensure there is a SessionCacheFactory
DefaultSessionCacheFactory cacheFactory = new DefaultSessionCacheFactory();

//Add the factory as a bean to the server, now whenever a
//SessionManager starts it will consult the bean to create a new DefaultSessionCache
server.addBean(cacheFactory);

//Configure the GCloudSessionDataStoreFactory
GCloudSessionDataStoreFactory storeFactory = new GCloudSessionDataStoreFactory();
storeFactory.setGracePeriodSec(3600);
storeFactory.setSavePeriodSec(0);
storeFactory.setBackoffMs(2000); //increase the time between retries of failed writes
storeFactory.setMaxRetries(10); //increase the number of retries of failed writes

//Add the factory as a bean on the server, now whenever a
//SessionManager starts, it will consult the bean to create a new GCloudSessionDataStore
//for use by the DefaultSessionCache
server.addBean(storeFactory);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cachingsessiondatastore"><a class="anchor" href="#cachingsessiondatastore"></a>The CachingSessionDataStore</h3>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/plantuml/svg/eNrLzCtJLUpLTE5VCE4tLs7Mz3NJLEn0TSzgSs5JLC5WcE5MzsjMS0eSCy7JL0rlysSmDSLFhUOPgpKhkoKWbkp-eZ4umI1mIRnaIBaimqNgU6Orq-CbmpsMNC81BVUSAPOiVDg=" alt="Diagram">
</div>
</div>
<div class="paragraph">
<p>The <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/CachingSessionDataStore.html">CachingSessionDataStore</a> is a special type of <code>SessionDataStore</code> that checks an L2 cache for <code>SessionData</code> before checking a delegate <code>SessionDataStore</code>.
This can improve the performance of slow stores.</p>
</div>
<div class="paragraph">
<p>The L2 cache is an instance of a <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/session/SessionDataMap.html">SessionDataMap</a>.
Jetty provides one implementation of this L2 cache based on <code>memcached</code>, <a href="https://eclipse.dev/jetty/javadoc/jetty-12/org/eclipse/jetty/memcached/session/MemcachedSessionDataMap.html">MemcachedSessionDataMap</a>.</p>
</div>
<div class="paragraph">
<p>This is an example of how to programmatically configure <code>CachingSessionDataStore</code>s, using a <a href="#datastore-file">FileSessionDataStore</a> as a delegate, and <code>memcached</code> as the L2 cache:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Server server = new Server();

//Make a factory for memcached L2 caches for SessionData
MemcachedSessionDataMapFactory mapFactory = new MemcachedSessionDataMapFactory();
mapFactory.setExpirySec(0); //items in memcached don't expire
mapFactory.setHeartbeats(true); //tell memcached to use heartbeats
mapFactory.setAddresses(new InetSocketAddress("localhost", 11211)); //use a local memcached instance
mapFactory.setWeights(new int[]{100}); //set the weighting

//Make a FileSessionDataStoreFactory for creating FileSessionDataStores
//to persist the session data
FileSessionDataStoreFactory storeFactory = new FileSessionDataStoreFactory();
storeFactory.setStoreDir(new File("/tmp/sessions"));
storeFactory.setGracePeriodSec(3600);
storeFactory.setSavePeriodSec(0);

//Make a factory that plugs the L2 cache into the SessionDataStore
CachingSessionDataStoreFactory cachingSessionDataStoreFactory = new CachingSessionDataStoreFactory();
cachingSessionDataStoreFactory.setSessionDataMapFactory(mapFactory);
cachingSessionDataStoreFactory.setSessionStoreFactory(storeFactory);

//Register it as a bean so that all SessionManagers will use it
//to make FileSessionDataStores that use memcached as an L2 SessionData cache.
server.addBean(cachingSessionDataStoreFactory);</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="compliance.html">Server Compliance Modes</a></span>
  <span class="next"><a href="websocket.html">WebSocket Server</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="footer-main">
    <figure class="footer-brand">
      <a class="logo" href="https://jetty.org"><img src="../../../../../_/img/jetty-logo.svg" alt="Eclipse Jetty" height="46" width="160"></a>
    </figure>
    <ul class="footer-brand-links">
      <li><a href="../../../../index.html">Docs</a></li>
      <li><a href="../../../../../support.html">Support</a></li>
      <li>Lists: <a href="http://dev.eclipse.org/mhonarc/lists/jetty-users/maillist.html" target="_blank" rel="noopener">users</a> - <a href="http://dev.eclipse.org/mhonarc/lists/jetty-dev/maillist.html" target="_blank" rel="noopener">dev</a></li>
      <li><a href="https://github.com/eclipse/jetty.project" target="_blank" rel="noopener">Source</a></li>
    </ul>
    <p class="footer-brand-follow">
      <a href="https://twitter.com/JettyProject" title="Follow us on X" target="_blank" rel="noopener"><img src="../../../../../_/img/x-logo.svg" alt="X logo" class="logo" width="24"><span class="handle">@JettyProject</span></a>
    </p>
  </div>
  <div class="footer-legal">
    <p>Copyright © 2008-2024 Webtide</p>
    <p>The <a href="https://github.com/jetty/jetty.website" target="_blank" rel="noopener">UI for this site</a> is derived from the Antora default UI and is licensed under the MPL-2.0 license. Several icons are imported from <a href="https://primer.style/octicons/" target="_blank" rel="noopener">Octicons</a> and are licensed under the MIT license.</p>
    <p>Eclipse Jetty® is a trademarks of the Eclipse Foundation, Inc.</p>
  </div>
  <div class="footer-thanks">
    <p>This project is made possible by Webtide. Additional thanks to the <a href="https://eclipse.org" target="_blank" rel="noopener">Eclipse Foundation</a> for hosting this project.</p>
    <p class="badges">
      <a href="https://webtide.com" title="Development led by Webtide" target="_blank" rel="noopener"><img src="../../../../../_/img/webtide-logo.png" alt="Webtide Logo" width="100"></a>
      <a href="https://jetbrains.com/idea" title="IntelliJ IDEA integration provided by JetBrains" target="_blank" rel="noopener"><img src="../../../../../_/img/jetbrains.svg" alt="Jetbrains Logo" width="24"></a>
    </p>
    <p>Authored in <a href="https://asciidoc.org" target="_blank" rel="noopener">AsciiDoc</a>.<br>Produced by <a href="https://antora.org" target="_blank" rel="noopener">Antora</a> and <a href="https://asciidoctor.org" target="_blank" rel="noopener">Asciidoctor</a>.</p>
  </div>
</footer>
<script id="site-script" src="../../../../../_/js/site.js" data-ui-root-path="../../../../../_"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../.." data-snippet-length="100" data-stylesheet="../../../../../_/css/search.css"></script>
<script async src="../../../../../search-index.js"></script>
  </body>
</html>